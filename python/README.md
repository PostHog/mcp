# PostHog MCP Python Implementation

This is a Python implementation of the PostHog MCP (Model Context Protocol) tools, equivalent to the TypeScript version. It provides a unified API client and tool registry for interacting with PostHog's analytics platform.

## Features

- **Unified API Client**: Type-safe API client with resource-based organization
- **Pydantic Models**: Full schema validation using Pydantic models generated from TypeScript Zod schemas
- **Async Support**: Built with async/await for optimal performance
- **Tool Registry**: Easy-to-use tool registry for executing MCP tools
- **Memory Caching**: Built-in caching for user state management
- **Modern Python**: Uses uv for dependency management and pyproject.toml configuration

## Setup

### 1. Install Dependencies with uv

For production:
```bash
uv sync
```

For development (includes schema generation tools):
```bash
uv sync --dev
```

### 2. Alternative: Create Virtual Environment Manually

If you prefer to use pip:
```bash
python3 -m venv venv
source venv/bin/activate  # On Windows: venv\Scripts\activate
pip install -e .
```

## Quick Start

```python
import asyncio
from tools.registry import ToolRegistry

async def main():
    # Initialize with your PostHog API token
    registry = ToolRegistry("your-posthog-api-token")
    
    try:
        # Get organizations
        orgs = await registry.execute_tool("organizations-get", {})
        print(orgs)
        
        # Set active organization and project
        await registry.execute_tool("organization-set-active", {"orgId": "org-id"})
        await registry.execute_tool("project-set-active", {"projectId": "project-id"})
        
        # Get feature flags
        flags = await registry.execute_tool("feature-flags-get-all", {})
        print(flags)
        
    finally:
        await registry.close()

asyncio.run(main())
```

## Available Tools

### Organizations
- `organizations-get`: Get all organizations
- `organization-set-active`: Set active organization

### Projects  
- `projects-get`: Get all projects
- `project-set-active`: Set active project

### Feature Flags
- `feature-flags-get-all`: List all feature flags
- `create-feature-flag`: Create a new feature flag
- `update-feature-flag`: Update existing feature flag
- `delete-feature-flag`: Delete a feature flag

### Insights
- `insights-get-all`: List all insights
- `create-insight`: Create a new insight
- `get-sql-insight`: Execute SQL query as insight

## Development

### Schema Generation

The Python implementation uses Pydantic models generated from the TypeScript Zod schemas:

```bash
# From the root directory
pnpm run schema:build          # Generate both JSON schema and Python models
```

This generates type-safe Pydantic models in `schema/tool_inputs.py` based on the shared JSON schema.

### Project Structure

```
python/
├── pyproject.toml           # Project configuration and dependencies
├── uv.lock                 # Locked dependency versions (generated by uv)
├── api/                    # API client implementation
├── lib/                    # Utilities and constants
├── schema/                 # Pydantic model definitions
│   └── tool_inputs.py      # Generated Pydantic models
├── tools/                  # MCP tool implementations
└── scripts/
    └── generate-pydantic-models.sh  # Schema generation script
```

### Running Commands

All Python commands should be run through uv:

```bash
# Run tests
uv run pytest

# Format code
uv run ruff format .

# Lint code
uv run ruff check --fix .

# Run Python scripts
uv run python your_script.py
```

### Dependencies

Dependencies are managed in `pyproject.toml`:

**Production:**
- `pydantic>=2.0.0` - Data validation and parsing
- `httpx>=0.25.0` - HTTP client for API requests
- `typing-extensions>=4.8.0` - Extended typing support
- `python-dateutil>=2.8.2` - Date parsing utilities

**Development:**
- `datamodel-code-generator[http]>=0.25.0` - Generate Pydantic models from JSON Schema
- `ruff>=0.1.0` - Fast Python linter and formatter
- `pytest>=7.0.0` - Testing framework
- `pytest-asyncio>=0.21.0` - Async testing support

## Architecture

The implementation follows the same patterns as the TypeScript version:

- **API Client**: Unified client with resource-based methods
- **Schema Validation**: Pydantic models for type safety
- **Tool Pattern**: Standardized tool interface with handlers
- **Result Type**: Consistent error handling with Result pattern
- **Context Injection**: Shared context for API client, cache, and state

## Configuration

Set environment mode by modifying `lib/constants.py`:

```python
DEV = False  # Set to True for localhost development
BASE_URL = "http://localhost:8010" if DEV else "https://us.posthog.com"
```

## Error Handling

All methods return a consistent Result type:

```python
@dataclass
class Result:
    success: bool
    data: Optional[Any] = None
    error: Optional[Exception] = None
```

## Comparison with TypeScript Version

This Python implementation provides feature parity with the TypeScript MCP server:

- Same API methods and endpoints
- Equivalent schema validation (Pydantic vs Zod)
- Identical tool interface and functionality
- Consistent error handling patterns
- Same caching and state management approach